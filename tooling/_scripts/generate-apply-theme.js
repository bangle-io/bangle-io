const fs = require('fs');
const path = require('path');
const prettier = require('prettier');

const { extractCSSVars } = require('@bangle.io/extract-css-vars');
const { publicDir } = require('./constants');

async function run() {
  const cssVars = await extractCSSVars(
    fs.readFileSync(path.join(publicDir, 'variables.css')),
    'utf8',
  );

  let data = cssVars.filter(([varName]) => {
    return varName.startsWith('BV-dark') || varName.startsWith('BV-light');
  });

  let result = data.map(([item, value]) => {
    if (item.startsWith('BV-dark-')) {
      item = item.slice('BV-dark-'.length);
    }
    if (item.startsWith('BV-light-')) {
      item = item.slice('BV-light-'.length);
    }

    return item;
  });

  let newResult = [];

  // dedupe the array and preserve the order
  result.forEach((element) => {
    if (!newResult.includes(element)) {
      newResult.push(element);
    }
  });

  fs.writeFileSync(
    path.resolve(__dirname, '..', '..', 'lib', 'slice-ui', 'css-vars.ts'),
    prettier.format(
      `// This is autogenerated by running "yarn g:css:update-css-vars"
export const cssVars = ${JSON.stringify(newResult, null, 2).replaceAll(
        '"',
        `'`,
      )};`,
      {
        parser: 'typescript',
        trailingComma: 'all',
        singleQuote: true,
      },
    ),
    'utf-8',
  );
}

run();
